// =============================================================================
// Enterprise AI Foundation Platform - Prisma Schema
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------------------------------
// Enums
// -----------------------------------------------------------------------------

enum Tier {
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum Role {
  OWNER
  ADMIN
  ANALYST
  VIEWER
}

enum DataSourceType {
  M365
  GOOGLE_WORKSPACE
  ODOO
  SAP_B1
  DYNAMICS
  HUBSPOT
  SALESFORCE
  CUSTOM
}

enum DataSourceStatus {
  PENDING
  CONNECTED
  ERROR
  DISABLED
}

enum SyncStatus {
  SUCCESS
  PARTIAL
  FAILED
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum AssessmentType {
  ERP_READINESS
  AI_READINESS
  DATA_QUALITY
  PROCESS_MATURITY
}

enum AssessmentStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
}

enum SOPStatus {
  DRAFT
  REVIEW
  APPROVED
  PUBLISHED
  ARCHIVED
}

enum EntityType {
  CUSTOMER
  SUPPLIER
  PRODUCT
  CONTACT
  EMPLOYEE
}

enum EntityStatus {
  PENDING
  REVIEW
  MERGED
  EXPORTED
}

// Advanced Intelligence Enums (T015)
enum IndexStatus {
  CREATING
  ACTIVE
  REINDEXING
  ERROR
}

enum SourceType {
  DOCUMENT
  EMAIL
  MESSAGE
  MEETING
}

enum DecisionStatus {
  DECISION_DRAFT
  REVIEWED
  DECISION_APPROVED
}

enum SopDraftStatus {
  SOP_DRAFT
  UNDER_REVIEW
  SOP_APPROVED
  SOP_PUBLISHED
}

enum OptimizationType {
  PARALLELIZATION
  ELIMINATION
  AUTOMATION
  REASSIGNMENT
}

enum SuggestionStatus {
  SUGGESTION_PENDING
  ACCEPTED
  REJECTED
  IMPLEMENTED
}

enum ModelStatus {
  TRAINING
  MODEL_ACTIVE
  DEPRECATED
}

// -----------------------------------------------------------------------------
// Organization & User Models
// -----------------------------------------------------------------------------

model Organization {
  id            String   @id @default(cuid())
  name          String
  slug          String   @unique
  industry      String?
  employeeCount Int?
  region        String   @default("DACH")
  tier          Tier     @default(STARTER)
  settings      Json     @default("{}")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  users         User[]
  dataSources   DataSource[]
  assessments   Assessment[]
  sops          SOP[]
  entityRecords EntityRecord[]
  auditLogs     AuditLog[]

  @@index([slug])
  @@index([tier])
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  name           String?
  role           Role     @default(VIEWER)
  authProviderId String?  @unique
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  auditLogs AuditLog[]

  @@index([organizationId])
  @@index([email])
}

// -----------------------------------------------------------------------------
// Data Source & Sync Models
// -----------------------------------------------------------------------------

model DataSource {
  id             String           @id @default(cuid())
  type           DataSourceType
  name           String
  status         DataSourceStatus @default(PENDING)
  config         Json
  syncSchedule   String?
  lastSyncAt     DateTime?
  lastSyncStatus SyncStatus?
  deltaToken     String?
  metadata       Json             @default("{}")
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  syncJobs SyncJob[]

  @@index([organizationId])
  @@index([type])
  @@index([status])
}

model SyncJob {
  id           String    @id @default(cuid())
  status       JobStatus @default(PENDING)
  startedAt    DateTime?
  completedAt  DateTime?
  eventsCount  Int       @default(0)
  errorMessage String?
  metadata     Json      @default("{}")
  createdAt    DateTime  @default(now())

  dataSourceId String
  dataSource   DataSource @relation(fields: [dataSourceId], references: [id], onDelete: Cascade)

  @@index([dataSourceId])
  @@index([status])
  @@index([createdAt])
}

// -----------------------------------------------------------------------------
// Assessment Model
// -----------------------------------------------------------------------------

model Assessment {
  id              String           @id @default(cuid())
  type            AssessmentType
  status          AssessmentStatus @default(DRAFT)
  overallScore    Float?
  scores          Json?
  findings        Json?
  recommendations Json?
  targetSystem    String?
  generatedAt     DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([type])
  @@index([status])
}

// -----------------------------------------------------------------------------
// SOP (Standard Operating Procedure) Model
// -----------------------------------------------------------------------------

model SOP {
  id           String    @id @default(cuid())
  processId    String
  title        String
  version      Int       @default(1)
  status       SOPStatus @default(DRAFT)
  content      Json
  confidence   Float?
  editDistance Float?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  publishedAt  DateTime?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([processId])
  @@index([status])
}

// -----------------------------------------------------------------------------
// Entity Record Model (Master Data Management)
// -----------------------------------------------------------------------------

model EntityRecord {
  id               String       @id @default(cuid())
  type             EntityType
  status           EntityStatus @default(PENDING)
  goldenRecord     Json
  sourceRecords    Json
  qualityScore     Float?
  matchedRecordIds String[]
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([type])
  @@index([status])
}

// -----------------------------------------------------------------------------
// Audit Log Model
// -----------------------------------------------------------------------------

model AuditLog {
  id           String   @id @default(cuid())
  action       String
  resourceType String
  resourceId   String?
  details      Json     @default("{}")
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
  @@index([resourceType, resourceId])
  @@index([userId])
  @@index([action])
}

// -----------------------------------------------------------------------------
// Advanced Intelligence Models
// -----------------------------------------------------------------------------

// T009: VectorIndex and Embedding models
model VectorIndex {
  id             String      @id @default(uuid())
  name           String      @unique
  embeddingModel String
  dimensions     Int
  documentCount  Int         @default(0)
  status         IndexStatus @default(CREATING)
  lastUpdatedAt  DateTime    @updatedAt
  createdAt      DateTime    @default(now())

  embeddings Embedding[]

  @@index([status])
}

model Embedding {
  id             String     @id @default(uuid())
  vectorIndexId  String
  sourceType     SourceType
  sourceId       String
  chunkIndex     Int
  chunkHash      String
  contentPreview String
  metadata       Json?
  tenantId       String
  createdAt      DateTime   @default(now())

  vectorIndex VectorIndex @relation(fields: [vectorIndexId], references: [id], onDelete: Cascade)

  @@index([sourceId, chunkIndex])
  @@index([tenantId])
  @@index([vectorIndexId])
}

// T010: McpSession and McpAuditLog models
model McpSession {
  id               String   @id @default(uuid())
  userId           String
  clientName       String
  clientVersion    String?
  ipAddress        String
  scopes           String[]
  rateLimitBucket  Int      @default(1000)
  rateLimitResetAt DateTime
  lastActivityAt   DateTime
  expiresAt        DateTime
  createdAt        DateTime @default(now())

  auditLogs McpAuditLog[]

  @@index([userId])
  @@index([expiresAt])
}

model McpAuditLog {
  id           String   @id @default(uuid())
  sessionId    String
  userId       String
  toolName     String
  parameters   Json
  responseSize Int
  durationMs   Int
  statusCode   Int
  errorMessage String?
  tenantId     String
  createdAt    DateTime @default(now())

  session McpSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([tenantId])
  @@index([sessionId])
}

// T011: DecisionRecord model
model DecisionRecord {
  id               String         @id @default(uuid())
  title            String
  summary          String         @db.Text
  decisionDate     DateTime?
  outcome          String?
  confidenceScore  Float
  participants     Json
  timeline         Json
  factors          Json
  sourceDocuments  String[]
  relatedDecisions String[]
  status           DecisionStatus @default(DECISION_DRAFT)
  generatedBy      String
  tenantId         String
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@index([tenantId])
  @@index([status])
  @@index([decisionDate])
}

// T012: SopDraft model
model SopDraft {
  id                String        @id @default(uuid())
  processId         String
  title             String
  content           String        @db.Text
  version           Int           @default(1)
  confidenceScore   Float
  stepCount         Int
  observedInstances Int
  variations        Json
  raciMatrix        Json
  status            SopDraftStatus @default(SOP_DRAFT)
  reviewedBy        String?
  approvedBy        String?
  generatedBy       String
  tenantId          String
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([processId])
  @@index([tenantId])
  @@index([status])
}

// T013: OptimizationSuggestion model
model OptimizationSuggestion {
  id               String           @id @default(uuid())
  processId        String
  type             OptimizationType
  title            String
  description      String           @db.Text
  impactEstimate   Json
  affectedSteps    String[]
  prerequisites    String[]
  risks            Json?
  simulationResult Json?
  status           SuggestionStatus @default(SUGGESTION_PENDING)
  rejectionReason  String?
  implementedAt    DateTime?
  generatedBy      String
  tenantId         String
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@index([processId])
  @@index([tenantId])
  @@index([status])
}

// T014: PredictionModel and Prediction models
model PredictionModel {
  id               String      @id @default(uuid())
  processType      String
  modelType        String
  modelVersion     String
  modelPath        String
  features         String[]
  metrics          Json
  trainingDataSize Int
  status           ModelStatus @default(TRAINING)
  lastTrainedAt    DateTime
  tenantId         String
  createdAt        DateTime    @default(now())

  predictions Prediction[]

  @@index([processType])
  @@index([tenantId])
  @@index([status])
}

model Prediction {
  id                 String          @id @default(uuid())
  modelId            String
  processInstanceId  String
  predictedValue     Float
  confidenceInterval Json
  actualValue        Float?
  features           Json
  accuracy           Float?
  tenantId           String
  createdAt          DateTime        @default(now())

  model PredictionModel @relation(fields: [modelId], references: [id], onDelete: Cascade)

  @@index([processInstanceId])
  @@index([tenantId])
  @@index([modelId])
}

// -----------------------------------------------------------------------------
// OPERATE Tier Models (002-operate-tier)
// -----------------------------------------------------------------------------

// T001: RoutingRule model
model RoutingRule {
  id               String   @id @default(uuid())
  name             String
  description      String?
  priority         Int      @default(100)
  isActive         Boolean  @default(true)
  criteria         Json     // RequestCriteria: categories, keywords, senders, urgency
  handler          Json     // RouteHandler: personId, teamId, escalationPath
  fallbackHandler  Json?    // Backup handler if primary unavailable
  workloadLimit    Int?     // Max workload before routing elsewhere
  createdBy        String
  organizationId   String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  decisions RoutingDecision[]

  @@index([organizationId])
  @@index([isActive])
  @@index([priority])
}

// T002: RoutingDecision model
model RoutingDecision {
  id              String   @id @default(uuid())
  requestId       String   @unique
  requestType     String
  requestContent  String   @db.Text
  categories      String[]
  urgencyScore    Float
  handlerId       String   // Person who received the request
  handlerType     String   // 'person' | 'team' | 'queue'
  ruleId          String?
  confidence      Float
  reasoning       String   @db.Text
  alternativeHandlers Json?
  responseTime    Int?     // milliseconds
  wasEscalated    Boolean  @default(false)
  wasRerouted     Boolean  @default(false)
  feedbackScore   Int?     // 1-5 rating
  feedbackComment String?
  organizationId  String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  rule RoutingRule? @relation(fields: [ruleId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([handlerId])
  @@index([createdAt])
  @@index([ruleId])
}

// T003: ExpertiseProfile model
model ExpertiseProfile {
  id              String   @id @default(uuid())
  personId        String   @unique
  personName      String
  skills          Json     // Array of { skill, level, confidence, lastDemonstrated }
  domains         String[]
  languages       String[]
  certifications  Json?
  processExpertise Json    // { processId, proficiencyLevel, instances }
  responseMetrics Json     // { avgResponseTime, satisfactionScore, volumeHandled }
  availability    Json     // { schedule, timezone, currentWorkload }
  lastUpdatedFrom String   // Source of last update
  organizationId  String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId])
  @@index([personId])
}

// T004: ConversationSession model
model ConversationSession {
  id              String   @id @default(uuid())
  userId          String
  title           String?
  context         Json     // Conversation context and history summary
  lastActivityAt  DateTime
  messageCount    Int      @default(0)
  tokensUsed      Int      @default(0)
  organizationId  String
  createdAt       DateTime @default(now())
  expiresAt       DateTime

  messages ConversationMessage[]

  @@index([userId])
  @@index([organizationId])
  @@index([lastActivityAt])
}

// T005: ConversationMessage model
model ConversationMessage {
  id           String   @id @default(uuid())
  sessionId    String
  role         String   // 'user' | 'assistant' | 'system'
  content      String   @db.Text
  citations    Json?    // Array of source citations
  toolCalls    Json?    // Any tool calls made
  tokensInput  Int
  tokensOutput Int
  latencyMs    Int
  createdAt    DateTime @default(now())

  session ConversationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
}

// T006: AutomatedAction model
model AutomatedAction {
  id                String   @id @default(uuid())
  name              String
  description       String?
  triggerType       String   // 'pattern' | 'threshold' | 'schedule' | 'event'
  triggerConfig     Json     // Pattern/threshold/schedule configuration
  actionType        String   // 'reminder' | 'escalation' | 'retry' | 'redistribute' | 'notify'
  actionConfig      Json     // Action-specific configuration
  requiresApproval  Boolean  @default(false)
  approvalRoles     String[]
  isActive          Boolean  @default(true)
  successCount      Int      @default(0)
  failureCount      Int      @default(0)
  lastTriggeredAt   DateTime?
  organizationId    String
  createdBy         String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  executions ActionExecution[]

  @@index([organizationId])
  @@index([isActive])
  @@index([triggerType])
}

// T007: ActionExecution model
model ActionExecution {
  id              String    @id @default(uuid())
  actionId        String
  triggerReason   String    @db.Text
  status          String    // 'pending_approval' | 'approved' | 'executing' | 'completed' | 'failed' | 'rolled_back'
  approvedBy      String?
  approvedAt      DateTime?
  executedAt      DateTime?
  completedAt     DateTime?
  result          Json?
  errorMessage    String?
  rollbackData    Json?     // Data needed to rollback
  wasRolledBack   Boolean   @default(false)
  rolledBackAt    DateTime?
  rolledBackBy    String?
  organizationId  String
  createdAt       DateTime  @default(now())

  action AutomatedAction @relation(fields: [actionId], references: [id], onDelete: Cascade)

  @@index([actionId])
  @@index([organizationId])
  @@index([status])
  @@index([createdAt])
}

// T008: ComplianceRule model
model ComplianceRule {
  id              String   @id @default(uuid())
  name            String
  description     String   @db.Text
  framework       String   // 'GDPR' | 'SOX' | 'ISO27001' | 'custom'
  category        String   // 'data_retention' | 'access_control' | 'process_compliance' | etc.
  ruleLogic       Json     // Rule evaluation logic
  severity        String   // 'critical' | 'high' | 'medium' | 'low'
  checkFrequency  String   // 'realtime' | 'hourly' | 'daily' | 'weekly'
  isActive        Boolean  @default(true)
  lastCheckedAt   DateTime?
  passCount       Int      @default(0)
  failCount       Int      @default(0)
  organizationId  String
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  evidence   ComplianceEvidence[]
  violations ComplianceViolation[]

  @@index([organizationId])
  @@index([framework])
  @@index([isActive])
}

// T009: ComplianceEvidence model
model ComplianceEvidence {
  id              String   @id @default(uuid())
  ruleId          String
  evidenceType    String   // 'access_log' | 'process_execution' | 'document' | 'approval'
  sourceId        String
  sourceType      String
  description     String
  metadata        Json?
  collectedAt     DateTime @default(now())
  expiresAt       DateTime?
  organizationId  String

  rule ComplianceRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([ruleId])
  @@index([organizationId])
  @@index([evidenceType])
  @@index([collectedAt])
}

// T010: ComplianceViolation model
model ComplianceViolation {
  id              String    @id @default(uuid())
  ruleId          String
  severity        String
  description     String    @db.Text
  affectedEntity  String
  affectedEntityId String?
  evidenceIds     String[]
  status          String    // 'open' | 'acknowledged' | 'remediated' | 'accepted_risk'
  assignedTo      String?
  resolvedBy      String?
  resolvedAt      DateTime?
  resolutionNotes String?
  dueDate         DateTime?
  organizationId  String
  detectedAt      DateTime  @default(now())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  rule ComplianceRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([ruleId])
  @@index([organizationId])
  @@index([status])
  @@index([severity])
  @@index([detectedAt])
}

// T011: DashboardWidget model
model DashboardWidget {
  id              String   @id @default(uuid())
  dashboardId     String   // Groups widgets together
  userId          String
  widgetType      String   // 'metric' | 'chart' | 'alert_list' | 'process_health' | etc.
  title           String
  config          Json     // Widget-specific configuration
  position        Json     // { x, y, width, height }
  refreshInterval Int      @default(60) // seconds
  isVisible       Boolean  @default(true)
  organizationId  String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([dashboardId])
  @@index([userId])
  @@index([organizationId])
}

// Enrichment Job tracking (from 001-enterprise-ai-foundation Phase 16)
model EnrichmentJob {
  id              String   @id @default(cuid())
  organizationId  String
  jobType         String
  totalEntities   Int
  enrichedCount   Int      @default(0)
  failedCount     Int      @default(0)
  skippedCount    Int      @default(0)
  duration        Int?     // milliseconds
  requestedBy     String
  status          String   // 'completed' | 'partial' | 'failed'
  startedAt       DateTime
  completedAt     DateTime?
  createdAt       DateTime @default(now())

  @@index([organizationId])
  @@index([status])
  @@index([createdAt])
}

// -----------------------------------------------------------------------------
// SCALE Tier Models (003-scale-enterprise)
// -----------------------------------------------------------------------------

// T001-T003, T017: Entity (Multi-Tenant) model with hierarchy support
model Entity {
  id                String         @id @default(cuid())
  name              String
  slug              String         @unique
  parentEntityId    String?
  configuration     Json           @default("{}")
  status            TenantStatus   @default(ACTIVE)
  dataRetentionDays Int            @default(730)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  parent            Entity?        @relation("EntityHierarchy", fields: [parentEntityId], references: [id])
  children          Entity[]       @relation("EntityHierarchy")
  dataSources       DataSource[]   @relation("EntityDataSources")
  ssoConfigurations SsoConfiguration[]
  scimLogs          ScimSyncLog[]
  apiTokens         ApiToken[]
  resellerAccount   ResellerAccount? @relation(fields: [resellerId], references: [id])
  resellerId        String?
  userPermissions   UserEntityPermission[]

  @@index([parentEntityId])
  @@index([status])
  @@index([resellerId])
}

// T002: EntityStatus enum for tenant lifecycle
enum TenantStatus {
  ACTIVE
  SUSPENDED
  ARCHIVED
}

// T017: UserEntityPermission for cross-entity access
model UserEntityPermission {
  id        String   @id @default(cuid())
  userId    String
  entityId  String
  canRead   Boolean  @default(true)
  canWrite  Boolean  @default(false)
  canAdmin  Boolean  @default(false)
  grantedBy String
  grantedAt DateTime @default(now())

  entity    Entity   @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@unique([userId, entityId])
  @@index([userId])
  @@index([entityId])
}

// T051-T053: PartnerApplication model for Partner API
model PartnerApplication {
  id               String            @id @default(cuid())
  name             String
  description      String?           @db.Text
  clientId         String            @unique @default(cuid())
  clientSecretHash String
  redirectUris     String[]
  scopes           String[]
  rateLimitTier    RateLimitTier     @default(STANDARD)
  webhookUrl       String?
  webhookSecret    String?
  isActive         Boolean           @default(true)
  ownerId          String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  tokens           ApiToken[]
  webhookSubscriptions WebhookSubscription[]

  @@index([clientId])
  @@index([ownerId])
}

// T053: RateLimitTier enum
enum RateLimitTier {
  FREE       // 100 req/hour
  STANDARD   // 1000 req/hour
  PREMIUM    // 10000 req/hour
}

// T052: ApiToken model for OAuth tokens
model ApiToken {
  id               String            @id @default(cuid())
  applicationId    String
  userId           String
  entityId         String
  accessTokenHash  String            @unique
  refreshTokenHash String?           @unique
  scopes           String[]
  expiresAt        DateTime
  lastUsedAt       DateTime?
  revokedAt        DateTime?
  createdAt        DateTime          @default(now())

  application      PartnerApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  entity           Entity            @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([userId])
  @@index([entityId])
}

// T089: ApiAuditLog for partner API audit trail
model ApiAuditLog {
  id              String   @id @default(cuid())
  applicationId   String
  userId          String?
  entityId        String
  method          String
  path            String
  statusCode      Int
  requestSize     Int
  responseSize    Int
  durationMs      Int
  ipAddress       String
  userAgent       String?
  errorMessage    String?
  createdAt       DateTime @default(now())

  @@index([applicationId])
  @@index([entityId])
  @@index([createdAt])
}

// T070-T075: WebhookSubscription model
model WebhookSubscription {
  id              String   @id @default(cuid())
  applicationId   String
  eventTypes      String[]
  targetUrl       String
  secret          String
  isActive        Boolean  @default(true)
  failureCount    Int      @default(0)
  lastDeliveredAt DateTime?
  lastFailedAt    DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  application     PartnerApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  deliveries      WebhookDelivery[]

  @@index([applicationId])
  @@index([isActive])
}

// WebhookDelivery for tracking delivery attempts
model WebhookDelivery {
  id              String   @id @default(cuid())
  subscriptionId  String
  eventType       String
  payload         Json
  status          String   // 'pending' | 'delivered' | 'failed' | 'retrying'
  attempts        Int      @default(0)
  lastAttemptAt   DateTime?
  deliveredAt     DateTime?
  statusCode      Int?
  responseBody    String?  @db.Text
  errorMessage    String?
  createdAt       DateTime @default(now())

  subscription    WebhookSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([status])
  @@index([createdAt])
}

// T103-T106: ResellerAccount model for white-label
model ResellerAccount {
  id               String            @id @default(cuid())
  name             String
  contactEmail     String
  billingEmail     String
  commissionRate   Float             @default(0)
  tier             ResellerTier
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  whiteLabelConfigs WhiteLabelConfig[]
  entities         Entity[]
}

// T105: ResellerTier enum
enum ResellerTier {
  RESELLER_STARTER
  RESELLER_PROFESSIONAL
  RESELLER_ENTERPRISE
}

// T104: WhiteLabelConfig model
model WhiteLabelConfig {
  id               String            @id @default(cuid())
  resellerId       String
  name             String
  customDomain     String?           @unique
  branding         Json              // { logo, colors, fonts }
  features         Json              @default("{}")
  customCss        String?           @db.Text
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  reseller         ResellerAccount   @relation(fields: [resellerId], references: [id], onDelete: Cascade)

  @@index([resellerId])
  @@index([customDomain])
}

// T245-T249: SsoConfiguration model for enterprise SSO
model SsoConfiguration {
  id               String            @id @default(cuid())
  entityId         String
  providerType     SsoProviderType
  providerName     String
  configuration    Json              // IdP-specific config (metadata, endpoints)
  attributeMapping Json              // SAML/OIDC attribute â†’ user field mapping
  groupRoleMapping Json              @default("{}")
  isActive         Boolean           @default(false)
  lastSyncAt       DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  entity           Entity            @relation(fields: [entityId], references: [id], onDelete: Cascade)
  scimLogs         ScimSyncLog[]

  @@unique([entityId, providerType])
  @@index([entityId])
}

// T247: SsoProviderType enum
enum SsoProviderType {
  SAML
  OIDC
}

// T246, T248: ScimSyncLog model
model ScimSyncLog {
  id               String            @id @default(cuid())
  entityId         String
  ssoConfigId      String
  operation        ScimOperation
  resourceType     ScimResourceType
  resourceId       String
  localUserId      String?
  changes          Json
  status           ScimSyncStatus
  errorMessage     String?           @db.Text
  createdAt        DateTime          @default(now())

  entity           Entity            @relation(fields: [entityId], references: [id], onDelete: Cascade)
  ssoConfig        SsoConfiguration  @relation(fields: [ssoConfigId], references: [id], onDelete: Cascade)

  @@index([entityId, createdAt])
  @@index([ssoConfigId])
}

// T248: SCIM enums
enum ScimOperation {
  SCIM_CREATE
  SCIM_UPDATE
  SCIM_DELETE
}

enum ScimResourceType {
  SCIM_USER
  SCIM_GROUP
}

enum ScimSyncStatus {
  SCIM_SUCCESS
  SCIM_FAILED
}

// T201-T204: BenchmarkSegment model for cross-company intelligence
model BenchmarkSegment {
  id               String            @id @default(cuid())
  name             String
  industry         String
  sizeRange        String
  region           String            @default("DACH")
  participantCount Int               @default(0)
  minimumRequired  Int               @default(10)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  metrics          AnonymizedMetric[]

  @@unique([industry, sizeRange, region])
}

// T202: AnonymizedMetric model
model AnonymizedMetric {
  id               String            @id @default(cuid())
  segmentId        String
  metricType       String
  value            Float
  sampleSize       Int
  confidenceLevel  Float
  periodStart      DateTime          @db.Date
  periodEnd        DateTime          @db.Date
  createdAt        DateTime          @default(now())

  segment          BenchmarkSegment  @relation(fields: [segmentId], references: [id], onDelete: Cascade)

  @@index([segmentId, metricType])
  @@index([periodStart, periodEnd])
}

// T203: BenchmarkOptIn tracking
model BenchmarkOptIn {
  id               String   @id @default(cuid())
  organizationId   String   @unique
  isOptedIn        Boolean  @default(false)
  consentGivenBy   String?
  consentGivenAt   DateTime?
  optOutRequestedBy String?
  optOutRequestedAt DateTime?
  dataRemovedAt    DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([isOptedIn])
}

// -----------------------------------------------------------------------------
// Additional Connectors Models (004-additional-connectors)
// -----------------------------------------------------------------------------

// T008: ConnectorInstance model - tracks individual connector configurations
model ConnectorInstance {
  id                String                @id @default(cuid())
  connectorType     String                // 'google_workspace', 'odoo', 'sap_b1', etc.
  name              String
  organizationId    String
  status            ConnectorStatus       @default(PENDING_SETUP)
  configuration     Json                  @default("{}")
  lastHealthCheck   DateTime?
  healthStatus      HealthStatus          @default(UNKNOWN)
  errorMessage      String?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt

  syncJobs          ConnectorSyncJob[]
  checkpoints       SyncCheckpoint[]
  credentials       ConnectorCredential[]
  errors            ConnectorError[]
  rateLimitStates   RateLimitState[]
  entityMappings    EntityMapping[]

  @@index([organizationId])
  @@index([connectorType])
  @@index([status])
}

// T008: ConnectorStatus enum
enum ConnectorStatus {
  PENDING_SETUP
  CONFIGURING
  AUTHENTICATING
  CONNECTED
  SYNCING
  PAUSED
  ERROR
  DISABLED
}

// T008: HealthStatus enum
enum HealthStatus {
  UNKNOWN
  HEALTHY
  DEGRADED
  UNHEALTHY
  DISCONNECTED
}

// T008: ConnectorSyncJob model - tracks sync operations
model ConnectorSyncJob {
  id                String            @id @default(cuid())
  instanceId        String
  syncType          SyncType          @default(INCREMENTAL)
  status            ConnectorJobStatus @default(PENDING)
  startedAt         DateTime?
  completedAt       DateTime?
  progress          Int               @default(0)  // 0-100
  eventsProcessed   Int               @default(0)
  errorsCount       Int               @default(0)
  errorMessage      String?           @db.Text
  metadata          Json              @default("{}")
  createdAt         DateTime          @default(now())

  instance          ConnectorInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@index([instanceId])
  @@index([status])
  @@index([createdAt])
}

// T008: SyncType enum
enum SyncType {
  FULL
  INCREMENTAL
  SELECTIVE
  REPAIR
}

// T008: ConnectorJobStatus enum
enum ConnectorJobStatus {
  PENDING
  INITIALIZING
  RUNNING
  PAUSED
  COMPLETED
  FAILED
  CANCELLED
}

// T008: SyncCheckpoint model - tracks sync progress for resume capability
model SyncCheckpoint {
  id                String            @id @default(cuid())
  instanceId        String
  resource          String            // e.g., 'emails', 'calendar', 'files'
  cursor            String?           // API cursor/page token
  timestamp         DateTime          // Last processed timestamp
  processedCount    Int               @default(0)
  metadata          Json              @default("{}")
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  instance          ConnectorInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@unique([instanceId, resource])
  @@index([instanceId])
}

// T009: ConnectorCredential model - stores encrypted credentials
model ConnectorCredential {
  id                String            @id @default(cuid())
  instanceId        String
  credentialType    String            // 'oauth_tokens', 'api_key', 'session_token', etc.
  encryptedData     String            @db.Text  // AES-256-GCM encrypted JSON
  keyId             String            // Reference to encryption key
  version           Int               @default(1)
  expiresAt         DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  instance          ConnectorInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@unique([instanceId, credentialType])
  @@index([instanceId])
  @@index([expiresAt])
}

// T009: EntityMapping model - maps external entities to internal entities
model EntityMapping {
  id                String            @id @default(cuid())
  instanceId        String
  externalId        String            // ID in source system
  externalType      String            // Type in source system (e.g., 'gmail_message', 'odoo_sale_order')
  internalId        String?           // ID in our system (if resolved)
  internalType      String?           // Type in our system
  metadata          Json              @default("{}")
  lastSyncedAt      DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  instance          ConnectorInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@unique([instanceId, externalType, externalId])
  @@index([instanceId])
  @@index([internalId])
}

// T010: ConnectorError model - logs connector errors for debugging
model ConnectorError {
  id                String            @id @default(cuid())
  instanceId        String
  errorCode         String
  errorType         String            // 'auth', 'rate_limit', 'sync', 'api', 'config'
  message           String            @db.Text
  stackTrace        String?           @db.Text
  context           Json              @default("{}")  // Additional context (request params, etc.)
  isResolved        Boolean           @default(false)
  resolvedAt        DateTime?
  resolvedBy        String?
  createdAt         DateTime          @default(now())

  instance          ConnectorInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@index([instanceId, createdAt])
  @@index([errorType])
  @@index([isResolved])
}

// T010: RateLimitState model - tracks API rate limit states
model RateLimitState {
  id                String            @id @default(cuid())
  instanceId        String
  endpoint          String            // API endpoint or category
  windowType        String            // 'second', 'minute', 'hour', 'day'
  limit             Int               // Max requests in window
  remaining         Int               // Remaining requests
  resetsAt          DateTime
  lastRequestAt     DateTime
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  instance          ConnectorInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@unique([instanceId, endpoint, windowType])
  @@index([instanceId])
  @@index([resetsAt])
}
